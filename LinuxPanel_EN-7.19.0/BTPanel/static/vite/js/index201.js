import{bD as e,k as t,o as l,I as a,_ as n,m as o,dy as s,bF as i}from"./page_layout.js?v=1732601582185";import{d as c,aq as r,r as u,O as d,X as p,Y as f,M as v,c as h,Z as m,u as _,R as g,P as w,Q as x,ap as b,e as y,F,ao as k,ax as C,L as U,aD as W,t as $,W as j,j as E,ac as O,k as I,v as B,n as M}from"./vue.js?v=1732601582185";import{aa as P,bU as R,bL as L,bK as q,ad as z,bk as A,bG as D,bV as N}from"./naive.js?v=1732601582185";import{e as G}from"./public.js?v=1732601582185";import"./common.js?v=1732601582185";import"./__commonjsHelpers__.js?v=1732601582185";const H=c({__name:"site-select",props:{value:{},valueModifiers:{}},emits:["update:value"],setup(t){const l=r(t,"value"),a=e(),n=u([]),o=()=>{l.value=n.value.map((e=>e.value))},s=()=>{l.value=[]};return(async()=>{n.value=Object.entries(a.config.sitemap).map((([e,t])=>({label:e,value:t})))})(),(e,t)=>{const a=P,i=R,c=L;return d(),p(c,_(e.$attrs,{value:l.value,"onUpdate:value":t[0]||(t[0]=e=>l.value=e),multiple:"",filterable:"",options:g(n),"max-tag-count":"responsive","consistent-menu-width":!1,placeholder:e.$t("Waf.Custom.index_25")}),{header:f((()=>[v(i,{class:"w-full"},{default:f((()=>[v(a,{class:"flex-1",onClick:o},{default:f((()=>[h(m(e.$t("Public.All")),1)])),_:1}),v(a,{class:"flex-1",onClick:s},{default:f((()=>[h(m(e.$t("Public.Btn.Cancel")),1)])),_:1})])),_:1})])),_:1},16,["value","options","placeholder"])}}}),K={class:"my-18px"};const Q=t({},[["render",function(e,t){const l=q;return d(),w("div",K,[v(l,{class:"w-38px justify-center"},{default:f((()=>[h(m(e.$t("Waf.Custom.index_31")),1)])),_:1})])}]]),S={class:"flex flex-center flex-col w-38px"};const V=t({},[["render",function(e,t){const l=q;return d(),w("div",S,[t[0]||(t[0]=x("div",{class:"seg"},null,-1)),v(l,{class:"w-38px justify-center"},{default:f((()=>[h(m(e.$t("Waf.Custom.index_30")),1)])),_:1}),t[1]||(t[1]=x("div",{class:"seg"},null,-1))])}],["__scopeId","data-v-7ea28fa1"]]),X={class:"relative flex items-center w-full h-full"},Y={class:"tips"},Z=t(c({__name:"content",props:b({condition:{default:null},factor:{},type:{default:"right"}},{input:{},inputModifiers:{},select:{default:()=>null},selectModifiers:{}}),emits:["update:input","update:select"],setup(e){const t=e,n=r(e,"input"),o=r(e,"select"),s=y((()=>null===t.condition)),i=["in","not_in"],c=y((()=>{const{factor:e}=t;return"text"===e.widget.type})),_=["select","area_select","mult"],b=y((()=>{const{factor:e}=t;return _.includes(e.widget.type)})),U=y((()=>"left"!==t.type&&("mult"===t.factor.widget.type||i.includes(t.condition||"")))),W=y((()=>{const{factor:e}=t,{widget:a}=e;return a.value.map((e=>({label:l(e)?e:e.label,value:l(e)?e:e.key})))})),$=()=>{o.value=W.value.map((e=>e.value))},j=()=>{o.value=[]},E=u(""),O=e=>{E.value=e},I=()=>{""!==E.value&&(a(o.value)?a(o.value)&&!o.value.includes(E.value)&&o.value.push(E.value):o.value=[E.value],E.value="")};return(e,t)=>{const l=z,a=L,i=P,r=R;return d(),w("div",X,[g(c)?(d(),w(F,{key:0},[g(U)?(d(),p(a,{key:1,value:o.value,"onUpdate:value":t[1]||(t[1]=e=>o.value=e),tag:"",multiple:"",filterable:"","show-arrow":!1,show:!1,"max-tag-count":"responsive","consistent-menu-width":!1,placeholder:e.factor.widget.placeholder,onSearch:O,onBlur:I},null,8,["value","placeholder"])):(d(),p(l,{key:0,value:n.value,"onUpdate:value":t[0]||(t[0]=e=>n.value=e),spellcheck:"false",disabled:g(s),placeholder:e.factor.widget.placeholder},null,8,["value","disabled","placeholder"])),x("div",Y,m(e.factor.widget.hint?"".concat(e.factor.widget.hint).concat(g(U)?e.$t("Waf.Custom.index_29"):""):""),1)],64)):k("",!0),g(b)?(d(),p(a,{key:1,value:o.value,"onUpdate:value":t[2]||(t[2]=e=>o.value=e),options:g(W),disabled:g(s),filterable:!0,"consistent-menu-width":!1,multiple:g(U),"max-tag-count":"responsive",placeholder:e.factor.widget.placeholder},C({_:2},[g(U)?{name:"header",fn:f((()=>[v(r,{class:"w-full"},{default:f((()=>[v(i,{class:"flex-1",onClick:$},{default:f((()=>[h(m(e.$t("Public.All")),1)])),_:1}),v(i,{class:"flex-1",onClick:j},{default:f((()=>[h(m(e.$t("Public.Btn.Cancel")),1)])),_:1})])),_:1})])),key:"0"}:void 0]),1032,["value","options","disabled","multiple","placeholder"])):k("",!0)])}}}),[["__scopeId","data-v-c8f1f83a"]]),J={class:"rows rows-tit"},T={class:"field"},ee={class:"condition"},te={class:"content"},le={class:"rows"},ae={class:"field"},ne={class:"condition"},oe={class:"content"},se={key:0,class:"w-140px mr-8px"},ie={class:"flex-1 w-0"},ce={class:"rows-btn"},re=["onClick"],ue=t(c({__name:"index",props:b({isInit:{type:Boolean,default:!0}},{value:{default:()=>[]},valueModifiers:{}}),emits:["update:value"],setup(t,{expose:l}){const o=t,s=r(t,"value"),i=e(),c={type:"or",children:[]},u={input:"",select:null,show:!1,widget:{hint:"",placeholder:"",type:"text",value:[]}},b={type:"and",field:null,condition:null,conOptions:[],leftFactor:A(u),rightFactor:A(u)},C=["select","area_select"],$=["in","not_in"],j=y((()=>i.config.options.map((e=>({label:e.text,value:e.type,data:e}))))),E=(e,t)=>(l,a)=>{const n=s.value[e].children[t],o=a.data;n.conOptions=o.operators.map((e=>({label:i.getOperatorName(e),value:e}))),n.condition=o.operators[0]||null,n.leftFactor=A(u),n.rightFactor=A(u),o.left_factor_enabled&&(n.leftFactor.show=o.left_factor_enabled,n.leftFactor.widget=o.left_widget),o.right_factor_enabled&&(n.rightFactor.widget=o.right_widget,n.rightFactor.show=o.right_factor_enabled)},O=(e,t)=>l=>{const n=s.value[e].children[t],{rightFactor:o}=n,{widget:i}=o;if(C.includes(i.type)){if(null===o.select)return;$.includes(l||"")?o.select=a(o.select)?o.select:[o.select]:o.select=a(o.select)?o.select[0]:o.select}"text"===i.type&&($.includes(l||"")&&""!==o.input&&(o.select=[o.input],o.input=""),null!==o.select&&(o.input=a(o.select)?o.select[0]:o.select))},I=y((()=>s.value.map((e=>e.children.length)).reduce(((e,t)=>e+t))>1)),B=(e,t)=>t===s.value.length-1&&e===s.value[t].children.length-1,M=(e,t=0)=>{s.value[t].children.splice(e+1,0,A(b))},R=()=>{s.value.push(A(c)),M(0,s.value.length-1)},q=(e,t,l)=>"text"!==l.widget.type||$.includes(t)?"":e,z=(e,t,l)=>$.includes(t)?e?e.split(","):[]:C.includes(l.widget.type)&&e||null;return o.isInit&&0===s.value.length&&R(),l({setRules:e=>{const t=[];e.children.forEach((e=>{const l=A(c);e.children.forEach((e=>{const{option:t}=e;if(!t)return;const a=A(b);a.field=t.type,a.condition=t.operator,((e,t)=>{const{options:l}=i.config;for(let a=0;a<l.length;a++)if(l[a].type===e){t(l[a]);break}})(t.type,(e=>{if(e.left_factor_enabled){const l=(null==t?void 0:t.left_factor)||"";a.leftFactor.show=e.left_factor_enabled,a.leftFactor.widget=e.left_widget,a.leftFactor.input=q(l,t.operator,a.leftFactor),a.leftFactor.select=z(l,t.operator,a.leftFactor)}if(e.right_factor_enabled){const l=(null==t?void 0:t.right_factor)||"";a.rightFactor.show=e.right_factor_enabled,a.rightFactor.widget=e.right_widget,a.rightFactor.input=q(l,t.operator,a.rightFactor),a.rightFactor.select=z(l,t.operator,a.rightFactor)}a.conOptions=e.operators.map((e=>({label:i.getOperatorName(e),value:e})))})),l.children.push(a)})),t.push(l)})),t.length>0?s.value=t:R()}}),(e,t)=>{const l=L,a=P,o=n;return d(),w("div",null,[x("div",J,[x("div",T,m(e.$t("Waf.Custom.index_26")),1),x("div",ee,m(e.$t("Waf.Custom.index_27")),1),x("div",te,m(e.$t("Waf.Custom.index_28")),1),t[0]||(t[0]=x("div",{class:"btn"},null,-1))]),(d(!0),w(F,null,U(s.value,((t,n)=>(d(),w("div",{key:"".concat(n+1)},[0!==n?(d(),p(Q,{key:0})):k("",!0),(d(!0),w(F,null,U(t.children,((t,i)=>(d(),w("div",{key:"".concat(i+1)},[0!==i?(d(),p(V,{key:0})):k("",!0),x("div",le,[x("div",ae,[v(l,_({value:t.field,"onUpdate:value":e=>t.field=e,options:g(j),"consistent-menu-width":!1},W({"update:value":E(n,i)})),null,16,["value","onUpdate:value","options"])]),x("div",ne,[t.leftFactor.show?(d(),p(Z,{key:0,input:t.leftFactor.input,"onUpdate:input":e=>t.leftFactor.input=e,select:t.leftFactor.select,"onUpdate:select":e=>t.leftFactor.select=e,type:"left",condition:t.condition,factor:t.leftFactor},null,8,["input","onUpdate:input","select","onUpdate:select","condition","factor"])):(d(),p(l,_({key:1,value:t.condition,"onUpdate:value":e=>t.condition=e,disabled:null===t.field,options:t.conOptions,"consistent-menu-width":!1},W({"update:value":O(n,i)})),null,16,["value","onUpdate:value","disabled","options"]))]),x("div",oe,[t.leftFactor.show?(d(),w("div",se,[v(l,_({value:t.condition,"onUpdate:value":e=>t.condition=e,disabled:null===t.field,options:t.conOptions,"consistent-menu-width":!1},W({"update:value":O(n,i)})),null,16,["value","onUpdate:value","disabled","options"])])):k("",!0),x("div",ie,[v(Z,{input:t.rightFactor.input,"onUpdate:input":e=>t.rightFactor.input=e,select:t.rightFactor.select,"onUpdate:select":e=>t.rightFactor.select=e,type:"right",condition:t.condition,factor:t.rightFactor},null,8,["input","onUpdate:input","select","onUpdate:select","condition","factor"])])]),x("div",ce,[v(a,{onClick:e=>M(i,n)},{default:f((()=>[h(m(e.$t("Waf.Custom.index_30")),1)])),_:2},1032,["onClick"]),B(i,n)?(d(),p(a,{key:0,class:"ml-8px",onClick:R},{default:f((()=>[h(m(e.$t("Waf.Custom.index_31")),1)])),_:1})):k("",!0),g(I)?(d(),w("div",{key:1,class:"close",onClick:e=>((e,t)=>{const l=s.value[t];l.children.length>1?l.children.splice(e,1):s.value.splice(t,1)})(i,n)},[v(o,{name:"base-close",size:"16"})],8,re)):k("",!0)])])])))),128))])))),128)),t[1]||(t[1]=x("div",null,null,-1))])}}}),[["__scopeId","data-v-b5148f31"]]),de={class:"p-24px"},pe={class:"form-title"},fe={class:"w-320px"},ve={class:"w-320px"},he={class:"form-title mt-8px"},me={class:"flex-1"},_e={class:"form-title mt-8px"},ge={class:"w-320px"},we={class:"w-320px"},xe=t(c({__name:"index",props:{isEdit:{type:Boolean},row:{}},emits:["refresh"],setup(t,{expose:l,emit:c}){const r=t,p=c,h=$(r,"isEdit"),{t:_}=j(),b=e(),y=E({name:"",server:[],action:"deny",response:null}),F={name:{trigger:["blur","input"],validator:()=>""!==y.name||new Error(_("Waf.Custom.index_18"))},rules:{validator:()=>{for(let e=0;e<k.value.length;e++){const t=k.value[e];for(let e=0;e<t.children.length;e++){const l=t.children[e];if(null===l.field||null===l.condition)return new Error(_("Waf.Custom.index_22"));const{leftFactor:a,rightFactor:n}=l;if(a.show&&""===a.input&&null===a.select)return new Error(_("Waf.Custom.index_22"));if(n.show&&""===n.input&&null===n.select)return new Error(_("Waf.Custom.index_22"))}}return!0}}},k=u([]),C=u(null),U=u(),W=u([]),R=u([]),q=()=>{y.server.length>0?G(y.server.join("\n")):o.error(_("Waf.Custom.index_24"))},A=(e,t)=>{const{data:l}=t,{response:a}=l;R.value=a.map((e=>({label:e.text,value:e.type}))),a.length>0?y.response=a[0].type:y.response=null},K=()=>{const e=Q();return k.value.forEach((t=>{const l=Q("and");t.children.forEach((e=>{null===e.field&&null===e.condition||l.children.push(S(e))})),e.children.push(l)})),e},Q=(e="or")=>({logic:e,type:"block",option:null,children:[]}),S=e=>({type:"option",logic:"",children:[],option:{type:e.field||"",operator:e.condition||"",left_factor:X(e.condition,e.leftFactor),right_factor:X(e.condition,e.rightFactor)}}),V=["in","not_in"],X=(e,t)=>{const{widget:l}=t;return"text"!==l.type||V.includes(e||"")?a(t.select)?t.select.join(","):t.select||"":t.input};return W.value=b.config.action.map((e=>({label:e.text,value:e.type,data:e}))),(()=>{const{data:e}=W.value.find((e=>e.value===y.action)),{response:t}=e;R.value=t.map((e=>({label:e.text,value:e.type}))),t.length>0&&null===y.response&&(y.response=t[0].type)})(),(()=>{if(!h.value)return;const{row:e}=r;e&&(y.name=e.name,y.server=e.servers||null,y.action=e.action.type,y.response=e.action.response.type,M((()=>{U.value.setRules(e.root)})))})(),l({onConfirm:async()=>{var e;await(null==(e=C.value)?void 0:e.validate());const t=(()=>{const{action:e,response:t}=y;return"allow"===e&&null===t&&(y.response="black_page"),{name:y.name,servers:y.server?y.server:[],status:1,is_global:0,priority:0,root:K(),action:{type:y.action,response:{type:y.response||"",response_id:0,status:0,headers:{},body:""}}}})(),{row:l}=r;h.value&&l?await s({infos:t,id:l.id}):await i(t),p("refresh")}}),(e,t)=>{const l=n,a=P,o=D,s=z,i=L,c=N;return d(),w("div",de,[v(c,{ref_key:"formRef",ref:C,model:g(y),rules:F,"label-width":"140px","label-placement":"left","require-mark-placement":"left"},{default:f((()=>[x("div",pe,m(e.$t("Waf.Custom.index_15")),1),v(o,{label:e.$t("Waf.Custom.index_16")},{default:f((()=>[x("div",fe,[v(H,{value:g(y).server,"onUpdate:value":t[0]||(t[0]=e=>g(y).server=e)},null,8,["value"])]),v(a,{class:"ml-16px",onClick:q},{default:f((()=>[v(l,{name:"common-copy",class:"mr-6px",size:"14"}),x("span",null,m(e.$t("Waf.Custom.index_23")),1)])),_:1})])),_:1},8,["label"]),v(o,{label:e.$t("Waf.Custom.index_17"),path:"name"},{default:f((()=>[x("div",ve,[v(s,{value:g(y).name,"onUpdate:value":t[1]||(t[1]=e=>g(y).name=e),spellcheck:"false",placeholder:e.$t("Waf.Custom.index_18")},null,8,["value","placeholder"])])])),_:1},8,["label"]),x("div",he,m(e.$t("Waf.Custom.index_19")),1),v(o,{label:"",class:"pl-36px",path:"rules"},{default:f((()=>[x("div",me,[v(ue,{ref_key:"ruleListRef",ref:U,value:g(k),"onUpdate:value":t[2]||(t[2]=e=>O(k)?k.value=e:null),"is-init":!g(h)},null,8,["value","is-init"])])])),_:1}),x("div",_e,m(e.$t("Waf.Custom.index_10")),1),v(o,{label:e.$t("Waf.Custom.index_20")},{default:f((()=>[x("div",ge,[v(i,{value:g(y).action,"onUpdate:value":[t[3]||(t[3]=e=>g(y).action=e),A],options:g(W)},null,8,["value","options"])])])),_:1},8,["label"]),I(v(o,{label:e.$t("Waf.Custom.index_21"),"show-feedback":!1},{default:f((()=>[x("div",we,[v(i,{value:g(y).response,"onUpdate:value":t[4]||(t[4]=e=>g(y).response=e),options:g(R)},null,8,["value","options"])])])),_:1},8,["label"]),[[B,"deny"===g(y).action]])])),_:1},8,["model"])])}}}),[["__scopeId","data-v-b93aa8ab"]]);export{xe as default};
