import{ae as e,j as a,g as t,h as s,n as i,q as l,B as o,eE as n}from"./index.js?v=1723125373998";import{_ as r}from"./index73.js?v=1723125373998";import{u as m,_ as c}from"./useTableData.js?v=1723125373998";import{u as p}from"./useLoading.js?v=1723125373998";import{a8 as u,a9 as d,aa as h,ab as f,ac as v}from"./mail.js?v=1723125373998";import{_ as w,a as y}from"./index.vue_vue_type_script_setup_true_lang6.js?v=1723125373998";import{l as _,r as x,f as b,S as g,Z as j,P as k,V as P,_ as R,W as C,t as D,ae as S,U as E,ad as B,q as L,a3 as z}from"./vue.js?v=1723125373998";import{_ as N}from"./index145.js?v=1723125373998";import{u as T}from"./useLoop.js?v=1723125373998";import"./pinia.js?v=1723125373998";import"./data.js?v=1723125373998";import"./Skeleton.js?v=1723125373998";import"./DataTable.js?v=1723125373998";import"./Checkbox.js?v=1723125373998";import"./Ellipsis.js?v=1723125373998";import"./Select.js?v=1723125373998";import"./Tag.js?v=1723125373998";import"./Empty.js?v=1723125373998";import"./omit.js?v=1723125373998";import"./Spin.js?v=1723125373998";const U={class:"p-20px"},q={class:"w-260px"},$=R("li",null,"Please enter the FQDN (Fully Qualified Domain Name e.g mail.aapanel.com)",-1),F=_({__name:"hostname",emits:["refresh"],setup(a,{expose:t,emit:s}){const i=s,l=x(null),o=b({hostname:""}),n={hostname:{trigger:["input","blur"],validator:()=>""!==o.hostname.trim()||new Error("Please enter the domain name")}};return t({onConfirm:async()=>{var e;await(null==(e=l.value)?void 0:e.validate()),await u(D(o)),i("refresh")}}),(a,t)=>{const s=e,i=w,m=y,c=r;return g(),j("div",U,[k(m,{ref_key:"formRef",ref:l,model:C(o),rules:n},{default:P((()=>[k(i,{label:"Domain name",path:"hostname"},{default:P((()=>[R("div",q,[k(s,{value:C(o).hostname,"onUpdate:value":t[0]||(t[0]=e=>C(o).hostname=e)},null,8,["value"])])])),_:1})])),_:1},8,["model"]),k(c,{class:"mt-8px"},{default:P((()=>[$])),_:1})])}}}),H=_({__name:"log",emits:["close","close-env"],setup(e,{emit:t}){const s=t,i=x("Log is empty"),l=async()=>{const{message:e}=await d();a(e)&&(i.value=e.result||"Log is empty")},{loop:o}=T((async()=>{await l()}),1),n=S();return(async()=>{(async()=>{await h(),s("close"),s("close-env"),n.push("/mail/domain")})(),await l(),o()})(),(e,a)=>{const t=N;return g(),E(t,{log:C(i)},null,8,["log"])}}}),I={class:"flex flex-col h-full overflow-hidden"},O={class:"flex-1 p-20px overflow-auto"},Q=R("li",null," If the mail server environment is abnormal, rectify the fault first. Go to the next step only after all exceptions are repaired ",-1),V=_({__name:"index",emits:["close"],setup(e,{emit:u}){const d=u,{t:h}=B(),w=["Redis-install","Redis-Passwd","SElinux"],{table:y,columns:_}=m([{key:"env",title:"The mail server env",width:150},{key:"details",title:"Details",ellipsis:{tooltip:!0},render:e=>{let a="";const{env:t,status:s,details:i}=e,l=w.includes(t);return a=i&&l?s?"Ready":i:s?"Ready":""!=i?i:"Abnormity",k("span",{class:s?"text-primary":"text-error"},[a])}},{key:"action",title:"Operation",width:120,render:e=>{const{env:a,status:t,details:s}=e;return w.includes(a)||!s||t?"no-operation":k("a",{class:"bt-link",href:"javascript:;",onClick:()=>{"HostName"===e.env?b(e):D(e)}},[h("Public.Btn.Repair")])}}]),x=t("Repair HostName",{onRefresh:()=>{N()}}),b=e=>{x.data.row=e,x.show=!0},D=e=>{s({title:"Repair the environment",content:"Whether to repair the mail server environment?",onConfirm:async()=>{const{env:a}=e;let t="";switch(a){case"Postfix-Version":case"Postfix-install":case"Sqlite-support":t="repair_postfix";break;case"Rspamd-install":t="install_rspamd";break;case"Dovecot-install":t="repair_dovecot"}await f(a,t),N()}})},{loading:S,setLoading:E}=p(),N=async()=>{try{E(!0);const{message:e}=await v();a(e)&&(y.data=Object.entries(e).map((([e,a])=>({env:e,details:a.msg,status:a.status}))))}finally{E(!1)}},T=()=>{d("close")},U=t("Initialization log",{onCloseEnv:()=>{T()}}),q=async()=>{y.data.every((e=>e.status))?U.show=!0:i.error("Please fix all exceptions and click submit")};return N(),(e,a)=>{const t=c,s=r,i=l,m=o,p=n;return g(),j("div",I,[R("div",O,[k(t,{"max-height":364,"single-line":!1,loading:C(S),data:C(y).data,columns:C(_)},null,8,["loading","data","columns"]),k(s,{class:"mt-20px"},{default:P((()=>[Q])),_:1}),k(i,{show:C(x).show,"onUpdate:show":a[0]||(a[0]=e=>C(x).show=e),title:C(x).title,data:C(x).data,width:500,footer:!0,component:F},null,8,["show","title","data"]),k(i,{show:C(U).show,"onUpdate:show":a[1]||(a[1]=e=>C(U).show=e),title:C(U).title,data:C(U).data,"hide-close":!0,width:700,height:490,component:H},null,8,["show","title","data"])]),k(p,null,{default:P((()=>[k(m,{class:"cancel-btn",color:"#cbcbcb",size:"small",onClick:T},{default:P((()=>[L(z(e.$t("Public.Btn.Cancel")),1)])),_:1}),k(m,{type:"primary",size:"small",onClick:N},{default:P((()=>[L(z(e.$t("Public.Btn.Refresh")),1)])),_:1}),k(m,{type:"primary",size:"small",onClick:q},{default:P((()=>[L(z(e.$t("Public.Btn.Submit")),1)])),_:1})])),_:1})])}}});export{V as default};
